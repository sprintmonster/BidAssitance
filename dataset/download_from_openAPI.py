# -*- coding: utf-8 -*-
"""Untitled18.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1QkUPhEL5CLRv8YtnavPSUyP_QRlfnwbX
"""

import requests
import pandas as pd
import time
from concurrent.futures import ThreadPoolExecutor, as_completed

# ==========================================
# ì„¤ì •ê°’
# ==========================================
SERVICE_KEY = "12f4e266320faf8c2b35e2e61a3ab2cfb197382cd1ff9abed239dfc98072faf9"
numOfRows = 999
inqryBgnDt = "202208180000"
inqryEndDt = "202303032358"
filename = "21_8_18.csv"

# ì„¸ì…˜ ìƒì„± (ì—°ê²° ì¬ì‚¬ìš©ìœ¼ë¡œ ì†ë„ í–¥ìƒ)
session = requests.Session()

# ==========================================
# 1. ê³µì‚¬ ê¸°ì´ˆê¸ˆì•¡ (ëŒ€ëŸ‰ ì¡°íšŒ)
# ==========================================
url_bssis = "https://apis.data.go.kr/1230000/ad/BidPublicInfoService/getBidPblancListInfoCnstwkBsisAmount"
all_items = []
page_no = 1

print("Dataset 1: ê¸°ì´ˆê¸ˆì•¡ ìˆ˜ì§‘ ì‹œì‘...")
while True:
    params = {
        "serviceKey": SERVICE_KEY, "pageNo": page_no, "numOfRows": numOfRows,
        "inqryDiv": 1, "inqryBgnDt": inqryBgnDt, "inqryEndDt": inqryEndDt, "type": "json"
    }
    try:
        res = session.get(url_bssis, params=params).json()
        body = res.get("response", {}).get("body", {})
        items = body.get("items", [])
        if isinstance(items, dict): items = items.get("item", [])
        if not isinstance(items, list): items = [items] if items else []

        if not items: break
        all_items.extend(items)

        total_count = body.get("totalCount", 0)
        print(f" - [1ë‹¨ê³„] {len(all_items)} / {total_count} ìˆ˜ì§‘ ì¤‘...")

        if len(all_items) >= total_count: break
        page_no += 1
    except Exception as e:
        print(f"Error in Step 1: {e}")
        break

df_bssis = pd.DataFrame(all_items)
if df_bssis.empty:
    print("ë°ì´í„°ê°€ ì—†ì–´ ì¢…ë£Œí•©ë‹ˆë‹¤.")
    exit()

# ì „ì²˜ë¦¬
df_bssis = df_bssis[["bidNtceNo", "bidNtceNm", "bssamt", "rsrvtnPrceRngBgnRate", "rsrvtnPrceRngEndRate"]]
df_bssis["ì˜ˆê°€ë²”ìœ„"] = df_bssis[["rsrvtnPrceRngBgnRate", "rsrvtnPrceRngEndRate"]].apply(
    lambda x: max(abs(pd.to_numeric(x.iloc[0], errors="coerce")), abs(pd.to_numeric(x.iloc[1], errors="coerce"))), axis=1
)
df_bssis = df_bssis.rename(columns={"bssamt": "ê¸°ì´ˆê¸ˆì•¡"})
df_bssis = df_bssis[["bidNtceNo", "bidNtceNm", "ê¸°ì´ˆê¸ˆì•¡", "ì˜ˆê°€ë²”ìœ„"]]
print(f"âœ“ 1ë‹¨ê³„ ì™„ë£Œ: {len(df_bssis)}ê±´")



# ==========================================
# 2. ì¶”ì •ê°€ê²©, ë‚™ì°°í•˜í•œìœ¨ (ëŒ€ëŸ‰ ì¡°íšŒ)
# ==========================================
url_rate = "https://apis.data.go.kr/1230000/ad/BidPublicInfoService/getBidPblancListInfoCnstwkPPSSrch"
all_rate_items = []
page_no = 1
print("Dataset 2: ì¶”ì •ê°€, ë‚™ì°°í•˜í•œìœ¨ ìˆ˜ì§‘ ì‹œì‘...")

while True:
    params = {
        "serviceKey": SERVICE_KEY, "pageNo": page_no, "numOfRows": numOfRows,
        "inqryDiv": 1, "inqryBgnDt": inqryBgnDt, "inqryEndDt": inqryEndDt, "type": "json"
    }
    try:
        res = session.get(url_rate, params=params).json()
        body = res.get("response", {}).get("body", {})
        items = body.get("items", [])
        if isinstance(items, dict): items = items.get("item", [])
        if not isinstance(items, list): items = [items] if items else []
        if not items: break
        all_rate_items.extend(items)
        if len(all_rate_items) >= body.get("totalCount", 0): break
        page_no += 1
    except:
        break

df_rate = pd.DataFrame(all_rate_items)
if not df_rate.empty:
    df_rate = df_rate[["bidNtceNo","presmptPrce", "sucsfbidLwltRate"]].rename(columns={"presmptPrce":"ì¶”ì •ê°€ê²©","sucsfbidLwltRate": "ë‚™ì°°í•˜í•œìœ¨"})
print("âœ“ 2ë‹¨ê³„ ì™„ë£Œ")

# ==========================================
# 3. ë³‘í•©
# ==========================================
df_all = df_bssis.merge(df_rate, on="bidNtceNo", how="left")
df = df_all.groupby("bidNtceNo", as_index=False).first()

# ==========================================
# 4. ë‚™ì°°ê°€ (ê¸°ê°„ ê²€ìƒ‰ìœ¼ë¡œ ë³€ê²½ - API ì ˆì•½ & ì†ë„ UP)
# ==========================================
# ì¤‘ìš”: ì—¬ê¸°ë„ ê¸°ì¡´ ì½”ë“œëŠ” ë°˜ë³µë¬¸ì´ì—ˆìœ¼ë‚˜, 'ê¸°ê°„ ê²€ìƒ‰'ì´ ë˜ë¯€ë¡œ í•œ ë²ˆì— ê°€ì ¸ì˜µë‹ˆë‹¤.
url_scsbid = "https://apis.data.go.kr/1230000/as/ScsbidInfoService/getScsbidListSttusCnstwkPPSSrch"
scsbid_rows = []
page_no = 1
print("Dataset 4: ë‚™ì°°ê°€ ì •ë³´ ìˆ˜ì§‘ ì‹œì‘...")

while True:
    params = {
        "serviceKey": SERVICE_KEY, "pageNo": page_no, "numOfRows": numOfRows,
        "inqryDiv": 1, "inqryBgnDt": inqryBgnDt, "inqryEndDt": inqryEndDt, "type": "json"
    }
    try:
        res = session.get(url_scsbid, params=params).json()
        body = res.get("response", {}).get("body", {})
        items = body.get("items", [])
        if isinstance(items, dict): items = items.get("item", [])
        if not isinstance(items, list): items = [items] if items else []
        if not items: break

        for item in items:
            scsbid_rows.append({"bidNtceNo": item.get("bidNtceNo"), "ë‚™ì°°ê°€": item.get("sucsfbidAmt")})

        if len(scsbid_rows) >= body.get("totalCount", 0): break
        page_no += 1
    except:
        break

df_scsbid = pd.DataFrame(scsbid_rows)
df = df.merge(df_scsbid, on="bidNtceNo", how="left")

# ì €ì¥
df.to_csv(filename, index=False, encoding="utf-8-sig")
print(f"ğŸ‰ ëª¨ë“  ì‘ì—… ì™„ë£Œ! íŒŒì¼ ì €ì¥ë¨: {filename}")